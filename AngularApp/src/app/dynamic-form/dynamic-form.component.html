<div class="container mt-5">
  <div class="card shadow-lg border-0">
    <div class="card-header bg-primary text-white text-center py-3">
      <h2 class="mb-0">Dynamic Payment Form</h2>
    </div>
    <div class="card-body">
      <div *ngFor="let section of formConfig?.sections" class="mb-4">
        <h3 class="text-dark fw-bold">{{ section.title }}</h3>
        <hr class="my-3" />

        <form [formGroup]="forms[section.section]" class="row g-4">
          <div *ngFor="let field of section.fields" class="col-md-4">
            <div class="mb-3">

              <!-- Label -->
              <label for="{{ field.field }}" class="form-label">
                {{ field.label}} <span *ngIf="field.required" class="text-danger">*</span>
              </label>

              <!-- Textbox -->
              <input *ngIf="field.type === 'textbox'" 
                [formControlName]="field.field"
                [id]="field.field"
                [required]="field.required"
                [pattern]="field.pattern || null"
                type="text"
                class="form-control" />

              <!-- Label Display -->
              <div *ngIf="field.type === 'label'">
                <p class="form-control-plaintext fw-bold">{{ field.value }}</p>
              </div>

              <!-- Lookup -->
              <div *ngIf="field.type === 'lookup'" class="input-group">
                <input [formControlName]="field.field"
                  [id]="field.field"
                  [required]="field.required"
                  type="text"
                  class="form-control"
                  (click)="openLookupModal(field, section)" readonly />
                <button class="btn btn-outline-secondary" type="button" (click)="openLookupModal(field, section)">
                  üîç
                </button>
              </div>

              <!-- Date -->
              <input *ngIf="field.type === 'date'"
                [formControlName]="field.field"
                [id]="field.field"
                type="date"
                class="form-control" />

              <!-- Checkbox -->
              <div class="form-check" *ngIf="field.type === 'checkbox'">
                <input [formControlName]="field.field"
                  [id]="field.field"
                  type="checkbox"
                  class="form-check-input" />
              </div>

              <!-- Dropdown -->
              <select *ngIf="field.type === 'dropdown'"
                [formControlName]="field.field"
                [id]="field.field"
                class="form-select">
                <option value="" disabled selected>-- Select --</option>
                <option *ngFor="let option of field.options" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>

              <!-- Textarea -->
              <textarea *ngIf="field.type === 'textarea'"
                [formControlName]="field.field"
                [id]="field.field"
                class="form-control"></textarea>

              <!-- Error Message -->
              <div *ngIf="forms[section.section].get(field.field)?.invalid && forms[section.section].get(field.field)?.touched"
                class="text-danger small mt-1">
                <small *ngIf="forms[section.section].get(field.field)?.errors?.['required']">
                  {{ field.label }} is required.
                </small>
                <small *ngIf="forms[section.section].get(field.field)?.errors?.['pattern']">
                  Invalid format for {{ field.label }}.
                </small>
              </div>

            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-end">
      <button class="btn btn-success me-2 shadow-sm px-4" (click)="onSubmit()" [disabled]="!isFormValid()">Submit</button>
      <button class="btn btn-outline-secondary shadow-sm px-4" (click)="onCancel()">Cancel</button>
    </div>
  </div>
</div>

<!-- Bootstrap Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title mx-auto fw-bold" id="confirmationModalLabel">{{ modalOptions.title }}</h5>
      </div>
      <div class="modal-body text-center">
        <p class="lead">{{ modalOptions.description }}</p>
      </div>
      <div class="modal-footer d-flex justify-content-center">
        <button *ngIf="modalOptions.isCancel" class="btn btn-outline-danger px-4" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary px-4" (click)="modalOptions.ok()">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Lookup Modal -->
<div class="modal fade" id="lookupModal" tabindex="-1" aria-labelledby="lookupModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title mx-auto" id="lookupModalLabel">{{ activeLookupField?.label }} Lookup</h5>
        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-hover table-striped">
          <thead class="table-dark">
            <tr>
              <th *ngFor="let header of lookupHeaders">{{ header.toString().charAt(0).toUpperCase() + header.toString().slice(1) }}</th>
            </tr>
          </thead>
          <tbody>
            <tr style="cursor: pointer;" *ngFor="let item of lookupData" (click)="selectLookupItem(item)">
              <td *ngFor="let header of lookupHeaders">{{ item[header] }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
